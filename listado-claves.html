<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listado de Claves</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script defer src="listado-claves.js"></script>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="menulat.css" />
  </head>
  <body>
    <div class="container">
        <header>
          <nav class="navbar navbar-expand-lg bg-body-dark ">
            <div class="container-fluid ">
              <a class="navbar-brand" href="#">
                <img
                  src="assets/img/logo.png"
                  alt="Logo"
                  height="40"
                  class="d-inline-block align-text-top"
                />
                ColtPasswd
              </a>
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <span class="nav-link disabled">Bienvenido, </span>
                  </li>
                  <li class="nav-item">
                    <span class="nav-link" id="user-name"></span>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        </header>
      <div class="row ">

        <div class="container-fluid">
          <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block  sidebar">
                <div id="sidebar-wrapper">
                    <ul class="sidebar-nav" style="margin-left:0;">
                        <li class="sidebar-brand">
                            
                                <a href="#menu-toggle"  id="menu-toggle" style="margin-top:20px;float:right;" > <i class="fa fa-bars " style="font-size:20px !Important;" aria-hidden="true" aria-hidden="true"></i> 
                            
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-sort-alpha-asc " aria-hidden="true"> </i> <span style="margin-left:10px;">Section</span>  </a>
                        </li>
                        <li>
                            <a href="#"> <i class="fa fa-play-circle-o " aria-hidden="true"> </i> <span style="margin-left:10px;"> Section</span> </a>
                        </li>
                        <li>
                            <a href="#"> <i class="fa fa-puzzle-piece" aria-hidden="true"> </i> <span style="margin-left:10px;"> Section</span> </a>
                        </li>
                        <li>
                            <a href="#"> <i class="fa fa-font" aria-hidden="true"> </i> <span style="margin-left:10px;"> Section</span> </a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-info-circle " aria-hidden="true"> </i> <span style="margin-left:10px;">Section </span> </a>
                        </li>
                        <li>
                            <a href="#"> <i class="fa fa-comment-o" aria-hidden="true"> </i> <span style="margin-left:10px;"> Section</span> </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
              <div
                class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom"
              >
                <h1 class="h2">Listado de Claves</h1>
                <button
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#addClaveModal"
                >
                  Agregar Clave
                </button>
              </div>

              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Nombre Clave</th>
                      <th>Usuario Clave</th>
                      <th>Clave</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="clavesTable"></tbody>
                </table>
              </div>
            </main>
          </div>
        </div>

        <!-- Modal para agregar clave -->
        <div
          class="modal fade"
          id="addClaveModal"
          tabindex="-1"
          aria-labelledby="addClaveModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addClaveModalLabel">
                  Agregar Clave
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <form id="addClaveForm">
                  <div class="mb-3">
                    <label for="NombreClave" class="form-label"
                      >Nombre de la Clave</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="NombreClave"
                      required
                    />
                    <input type="hidden" id="IdUsuario" value="" />
                  </div>
                  <div class="mb-3">
                    <label for="UsuarioClave" class="form-label">Usuario</label>
                    <input
                      type="text"
                      class="form-control"
                      id="UsuarioClave"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="Clave" class="form-label">Clave</label>
                    <input
                      type="text"
                      class="form-control"
                      id="Clave"
                      required
                    />
                  </div>
                  <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
                <div id="error" class="alert alert-danger mt-3 d-none"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Agregar clave
      function addClave() {
        // Redirigir a una página de formulario para agregar clave
        window.location.href = "add_clave.php";
      }

      // Editar clave
      function editClave(id) {
        // Redirigir a una página de formulario para editar clave
        window.location.href = `edit_clave.php?id=${id}`;
      }

      // Borrar clave
      async function deleteClave(id) {
        const token = localStorage.getItem("token");
        if (confirm("¿Estás seguro de que deseas borrar esta clave?")) {
          try {
            await axios.delete(`http://localhost:3000/api/claves/${id}`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            alert("Clave borrada exitosamente.");
            fetchClaves();
          } catch (error) {
            alert("Error al borrar la clave.");
            console.error(error);
          }
        }
      }

      // Lógica para cerrar sesión
      function logout() {
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }
    </script>

    <script>
      // Lógica para agregar clave desde el modal
      document
        .getElementById("addClaveForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const token = localStorage.getItem("token");
          const IdUsuario = document.getElementById("IdUsuario").value;
          const NombreClave = document.getElementById("NombreClave").value;
          const UsuarioClave = document.getElementById("UsuarioClave").value;
          const Clave = document.getElementById("Clave").value;

          try {
            const response = await fetch("http://localhost:3000/api/claves", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                IdUsuario,
                NombreClave,
                UsuarioClave,
                Clave,
              }),
            });

            const data = await response.json();

            if (data.success) {
              alert("Clave ingresada con exito");
              document.getElementById("addClaveForm").reset(); // Limpiar formulario
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addClaveModal")
              );
              modal.hide(); // Cerrar modal
            } else {
              errorDiv.textContent =
                data.message || "Error en el ingreso del registro.";
              errorDiv.classList.remove("d-none");
            }
          } catch (error) {
            errorDiv.textContent = "Error en el servidor.";
            errorDiv.classList.remove("d-none");
          }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const token = localStorage.getItem("token");
      // Obtener el nombre de usuario del token
      if (token) {
        // Decodificar el token (si está encriptado) y extraer el nombre de usuario
        // Ejemplo:
        const decodedToken = JSON.parse(atob(token.split(".")[1]));
        const userName = decodedToken.Nombre + " " + decodedToken.Apellido;
        const IdUsuario = decodedToken.IdUsuario;
        document.getElementById("user-name").textContent = userName;
        document.getElementById("IdUsuario").value = IdUsuario;
      } else {
        // Redirigir al usuario a la página de inicio de sesión si no hay token
        window.location.href = "login.php";
      }

      // Función para cerrar sesión
      function logout() {
        localStorage.removeItem("token");
        window.location.href = "login.php";
      }
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

   


    <script>
        $("#menu-toggle").click(function(e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
        });
        </script>
  </body>
</html>
